name: Build GTFS Database

on:
  # Esecuzione automatica ogni giorno alle 04:00 UTC (05:00/06:00 ora italiana)
  schedule:
    - cron: '0 4 * * *'
  
  # Permette esecuzione manuale dal tab Actions
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Necessario per creare release e tag
      id-token: write  # Necessario per autenticazione
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y sqlite3 && pip install pandas requests
      
      - name: Get current date
        id: date
        run: |
          echo "BUILD_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV
          echo "BUILD_TIMESTAMP=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_ENV
      
      - name: Build Database
        run: |
          python scripts/build_db.py
      
      - name: Verify Database Integrity
        run: |
          # Verifica che il database esista e contenga tabelle
          if [ ! -f output/rome_gtfs.db ]; then
            echo "âŒ ERRORE: Database non trovato!"
            exit 1
          fi
          
          # Verifica che non sia vuoto
          SIZE=$(stat -f%z output/rome_gtfs.db 2>/dev/null || stat -c%s output/rome_gtfs.db)
          if [ "$SIZE" -lt 100000 ]; then  # Meno di 100KB = probabilmente vuoto
            echo "âŒ ERRORE: Database troppo piccolo ($SIZE bytes)!"
            exit 1
          fi
          
          # Verifica che contenga la tabella routes
          TABLES=$(sqlite3 output/rome_gtfs.db "SELECT name FROM sqlite_master WHERE type='table';")
          if ! echo "$TABLES" | grep -q "routes"; then
            echo "âŒ ERRORE: Tabella 'routes' non trovata nel database!"
            echo "Tabelle trovate: $TABLES"
            exit 1
          fi
          
          # Conta righe in routes
          ROUTE_COUNT=$(sqlite3 output/rome_gtfs.db "SELECT COUNT(*) FROM routes;")
          if [ "$ROUTE_COUNT" -lt 10 ]; then
            echo "âŒ ERRORE: Troppo poche route ($ROUTE_COUNT), database probabilmente incompleto!"
            exit 1
          fi
          
          echo "âœ… Database valido: $SIZE bytes, $ROUTE_COUNT routes"
      
      - name: Check if database changed
        id: check_changes
        run: |
          # Calcola hash del nuovo database
          NEW_HASH=$(md5sum output/rome_gtfs.db | cut -d' ' -f1)
          echo "new_hash=$NEW_HASH" >> $GITHUB_OUTPUT
          
          # Scarica manifest precedente (se esiste)
          OLD_HASH=""
          if curl -f -s -o old_manifest.json \
            "https://github.com/${{ github.repository }}/releases/download/latest-db/manifest.json"; then
            OLD_HASH=$(jq -r '.hash' old_manifest.json)
            echo "Hash precedente: $OLD_HASH"
          else
            echo "Nessun database precedente trovato"
          fi
          
          # Confronta hash
          if [ "$NEW_HASH" != "$OLD_HASH" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ“ Database cambiato, procedo con release"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "âœ“ Database identico, skip release"
          fi
      
      - name: Compress Database
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          cd output
          gzip -k rome_gtfs.db
          
          # Mostra dimensioni
          echo "Database originale: $(du -h rome_gtfs.db | cut -f1)"
          echo "Database compresso: $(du -h rome_gtfs.db.gz | cut -f1)"
      
      - name: Update manifest with correct URL
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          # Aggiorna URL nel manifest.json
          REPO_URL="https://github.com/${{ github.repository }}"
          jq --arg url "$REPO_URL/releases/download/db-${{ env.BUILD_DATE }}/rome_gtfs.db.gz" \
             '.download_url = $url' output/manifest.json > output/manifest_updated.json
          mv output/manifest_updated.json output/manifest.json
          
          echo "Manifest aggiornato:"
          cat output/manifest.json
      
      - name: Create dated release
        if: steps.check_changes.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          # Elimina release esistente se presente (utile per re-run falliti)
          gh release delete "db-${{ env.BUILD_DATE }}" --yes 2>/dev/null || true
          
          gh release create "db-${{ env.BUILD_DATE }}" \
            output/rome_gtfs.db.gz \
            output/manifest.json \
            --title "ðŸ“¦ GTFS Database - ${{ env.BUILD_DATE }}" \
            --notes "## ðŸš Database GTFS Roma MobilitÃ 
          
          **Data build:** ${{ env.BUILD_DATE }}
          **Hash MD5:** \`${{ steps.check_changes.outputs.new_hash }}\`
          
          ### ðŸ“¥ Download
          - **Database compresso:** \`rome_gtfs.db.gz\` (~10-15 MB)
          - **Metadata:** \`manifest.json\` (info versione e hash)
          
          ### ðŸ“Š Contenuto
          Database SQLite pre-indicizzato contenente:
          - Fermate (stops)
          - Linee (routes)
          - Percorsi (trips)
          - Orari (stop_times)
          - Calendari (calendar, calendar_dates)
          - Tracciati geografici (shapes)
          
          ### ðŸ”§ Utilizzo
          \`\`\`bash
          # Scarica e decomprimi
          wget https://github.com/${{ github.repository }}/releases/download/db-${{ env.BUILD_DATE }}/rome_gtfs.db.gz
          gunzip rome_gtfs.db.gz
          
          # Usa con SQLite
          sqlite3 rome_gtfs.db 'SELECT * FROM routes LIMIT 5;'
          \`\`\`
          
          ---
          *Generato automaticamente da GitHub Actions*"
      
      - name: Update latest tag
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          # Mantieni sempre un tag 'latest-db' per facile accesso
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Crea/aggiorna tag latest
          git tag -f latest-db
          git push origin latest-db --force
      
      - name: Create latest release (moving tag)
        if: steps.check_changes.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          # Elimina release esistente se presente
          gh release delete latest-db --yes --cleanup-tag 2>/dev/null || true
          
          # Crea nuova release
          gh release create "latest-db" \
            output/rome_gtfs.db.gz \
            output/manifest.json \
            --title "ðŸ“¦ Latest GTFS Database" \
            --notes "## ðŸš Ultima Versione Database GTFS
          
          Questo Ã¨ sempre l'ultimo database generato.
          
          **Ultimo aggiornamento:** ${{ env.BUILD_DATE }}
          **Hash MD5:** \`${{ steps.check_changes.outputs.new_hash }}\`
          
          ### ðŸ”— Link Stabili
          Usa questi URL nell'app per scaricare sempre l'ultima versione:
          - Database: \`https://github.com/${{ github.repository }}/releases/download/latest-db/rome_gtfs.db.gz\`
          - Manifest: \`https://github.com/${{ github.repository }}/releases/download/latest-db/manifest.json\`
          
          ---
          *Aggiornato automaticamente ogni giorno alle 04:00 UTC*"
      
      - name: Summary
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          echo "## âœ… Build Completata" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Data:** ${{ env.BUILD_DATE }}" >> $GITHUB_STEP_SUMMARY
          echo "**Hash:** \`${{ steps.check_changes.outputs.new_hash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Release create:" >> $GITHUB_STEP_SUMMARY
          echo "- [db-${{ env.BUILD_DATE }}](https://github.com/${{ github.repository }}/releases/tag/db-${{ env.BUILD_DATE }})" >> $GITHUB_STEP_SUMMARY
          echo "- [latest-db](https://github.com/${{ github.repository }}/releases/tag/latest-db)" >> $GITHUB_STEP_SUMMARY
      
      - name: No changes detected
        if: steps.check_changes.outputs.changed == 'false'
        run: |
          echo "## â„¹ï¸ Nessun Cambiamento" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Il database GTFS non Ã¨ cambiato rispetto alla versione precedente." >> $GITHUB_STEP_SUMMARY
          echo "Nessuna nuova release creata." >> $GITHUB_STEP_SUMMARY

